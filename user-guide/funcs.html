
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.9">
    
    
      
        <title>More Function - llir/llvm</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#more-function" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="llir/llvm" class="md-header__button md-logo" aria-label="llir/llvm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            llir/llvm
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              More Function
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="llir/llvm" class="md-nav__button md-logo" aria-label="llir/llvm" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    llir/llvm
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="basic.html" class="md-nav__link">
        Basic Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="control.html" class="md-nav__link">
        Control Flow
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          More Function
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="funcs.html" class="md-nav__link md-nav__link--active">
        More Function
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linkage" class="md-nav__link">
    Linkage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variant-argument-aka-vaarg" class="md-nav__link">
    Variant Argument (a.k.a. VAArg)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-overloading" class="md-nav__link">
    Function Overloading
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-class-functionclosure" class="md-nav__link">
    First-class Function(Closure)
  </a>
  
    <nav class="md-nav" aria-label="First-class Function(Closure)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#naive-implementation" class="md-nav__link">
    Naive Implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improvements" class="md-nav__link">
    Improvements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-structure" class="md-nav__link">
    Return Structure
  </a>
  
    <nav class="md-nav" aria-label="Return Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-parameter-attributes" class="md-nav__link">
    Add parameter attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="types.html" class="md-nav__link">
        High Level Types
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linkage" class="md-nav__link">
    Linkage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#variant-argument-aka-vaarg" class="md-nav__link">
    Variant Argument (a.k.a. VAArg)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#function-overloading" class="md-nav__link">
    Function Overloading
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-class-functionclosure" class="md-nav__link">
    First-class Function(Closure)
  </a>
  
    <nav class="md-nav" aria-label="First-class Function(Closure)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#naive-implementation" class="md-nav__link">
    Naive Implementation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improvements" class="md-nav__link">
    Improvements
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-structure" class="md-nav__link">
    Return Structure
  </a>
  
    <nav class="md-nav" aria-label="Return Structure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-parameter-attributes" class="md-nav__link">
    Add parameter attributes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="more-function">More Function</h1>
<h3 id="linkage">Linkage</h3>
<p>The following code shows some linkage can use in IR.</p>
<pre><code class="language-go">m := ir.NewModule()

add := m.NewFunc(&quot;add&quot;, types.I64, ir.NewParam(&quot;&quot;, types.I64))
add.Linkage = enum.LinkageInternal
add1 := m.NewFunc(&quot;add1&quot;, types.I64, ir.NewParam(&quot;&quot;, types.I64))
add1.Linkage = enum.LinkageLinkOnce
add2 := m.NewFunc(&quot;add2&quot;, types.I64, ir.NewParam(&quot;&quot;, types.I64))
add2.Linkage = enum.LinkagePrivate
add3 := m.NewFunc(&quot;add3&quot;, types.I64, ir.NewParam(&quot;&quot;, types.I64))
add3.Linkage = enum.LinkageWeak
add4 := m.NewFunc(&quot;add4&quot;, types.I64, ir.NewParam(&quot;&quot;, types.I64))
add4.Linkage = enum.LinkageExternal
</code></pre>
<p>The code would produce:</p>
<pre><code class="language-llvm">declare internal i64 @add(i64)

declare linkonce i64 @add1(i64)

declare private i64 @add2(i64)

declare weak i64 @add3(i64)

declare external i64 @add4(i64)
</code></pre>
<p>For further information about linkage, refer to <a href="https://llvm.org/docs/LangRef.html#linkage-types">LLVM doc</a> and <a href="https://pkg.go.dev/github.com/llir/llvm/ir/enum?tab=doc#Linkage">pkg.go.dev</a>.</p>
<h3 id="variant-argument-aka-vaarg">Variant Argument (a.k.a. VAArg)</h3>
<p>One example of a variadic function is <code>printf</code>. This is how to create a function prototype for <code>printf</code>:</p>
<pre><code class="language-go">m := ir.NewModule()

printf := m.NewFunc(
    &quot;printf&quot;,
    types.I32,
    ir.NewParam(&quot;&quot;, types.NewPointer(types.I8)),
)
printf.Sig.Variadic = true
</code></pre>
<p>The above code would produce the following IR:</p>
<pre><code class="language-llvm">declare i32 @printf(i8*, ...)
</code></pre>
<h3 id="function-overloading">Function Overloading</h3>
<p>There is no overloading in LLVM IR. One solution is to create one function per function signature, where each LLVM IR function would have a unique name (this is why C++ compilers do name mangling).</p>
<h3 id="first-class-functionclosure">First-class Function(Closure)</h3>
<h4 id="naive-implementation">Naive Implementation</h4>
<p>Create a closure(a.k.a. first-class function) requires a place to store captured variables. In LLVM, the best way is create a structure for such case:</p>
<pre><code class="language-go">m := ir.NewModule()

zero := constant.NewInt(types.I32, 0)
one := constant.NewInt(types.I32, 1)

captureStruct := m.NewTypeDef(&quot;id_capture&quot;, types.NewStruct(
    types.I32,
))
captureTyp := types.NewPointer(captureStruct)
idFn := m.NewFunc(&quot;id&quot;, types.I32, ir.NewParam(&quot;capture&quot;, captureTyp))
idB := idFn.NewBlock(&quot;&quot;)
v := idB.NewGetElementPtr(captureStruct, idFn.Params[0], zero, zero)
idB.NewRet(idB.NewLoad(types.I32, v))
idClosureTyp := m.NewTypeDef(&quot;id_closure&quot;, types.NewStruct(
    captureTyp,
    idFn.Type(),
))

mainFn := m.NewFunc(&quot;main&quot;, types.I32)
b := mainFn.NewBlock(&quot;&quot;)
// define a local variable `i`
i := b.NewAlloca(types.I32)
b.NewStore(constant.NewInt(types.I32, 10), i)
// use alloca at here to simplify code, in real case should be `malloc` or `gc_malloc`
captureInstance := b.NewAlloca(captureStruct)
ptrToCapture := b.NewGetElementPtr(captureStruct, captureInstance, zero, zero)
// capture variable
b.NewStore(b.NewLoad(types.I32, i), ptrToCapture)
// prepare closure
idClosure := b.NewAlloca(idClosureTyp)
ptrToCapturePtr := b.NewGetElementPtr(idClosureTyp, idClosure, zero, zero)
b.NewStore(captureInstance, ptrToCapturePtr)
ptrToFuncPtr := b.NewGetElementPtr(idClosureTyp, idClosure, zero, one)
b.NewStore(idFn, ptrToFuncPtr)
// assuming we transfer closure into another context
accessCapture := b.NewGetElementPtr(idClosureTyp, idClosure, zero, zero)
accessFunc := b.NewGetElementPtr(idClosureTyp, idClosure, zero, one)
result := b.NewCall(b.NewLoad(idFn.Type(), accessFunc), b.NewLoad(captureTyp, accessCapture))

printIntegerFormat := m.NewGlobalDef(&quot;tmp&quot;, constant.NewCharArrayFromString(&quot;%d\n&quot;))
pointerToString := b.NewGetElementPtr(types.NewArray(3, types.I8), printIntegerFormat, zero, zero)
// ignore printf
b.NewCall(printf, pointerToString, result)

b.NewRet(constant.NewInt(types.I32, 0))
</code></pre>
<p>This is a huge example, I understand it's hard to read, but concept is clean. It would generate below LLVM IR:</p>
<pre><code class="language-llvm">%id_capture = type { i32 }
%id_closure = type { %id_capture*, i32 (%id_capture*)* }

@tmp = global [3 x i8] c&quot;%d\0A&quot;

declare i32 @printf(i8* %format, ...)

define i32 @id(%id_capture* %capture) {
; &lt;label&gt;:0
    %1 = getelementptr %id_capture, %id_capture* %capture, i32 0, i32 0
    %2 = load i32, i32* %1
    ret i32 %2
}

define i32 @main() {
; &lt;label&gt;:0
    %1 = alloca i32
    store i32 10, i32* %1
    %2 = alloca %id_capture
    %3 = getelementptr %id_capture, %id_capture* %2, i32 0, i32 0
    %4 = load i32, i32* %1
    store i32 %4, i32* %3
    %5 = alloca %id_closure
    %6 = getelementptr %id_closure, %id_closure* %5, i32 0, i32 0
    store %id_capture* %2, %id_capture** %6
    %7 = getelementptr %id_closure, %id_closure* %5, i32 0, i32 1
    store i32 (%id_capture*)* @id, i32 (%id_capture*)** %7
    %8 = getelementptr %id_closure, %id_closure* %5, i32 0, i32 0
    %9 = getelementptr %id_closure, %id_closure* %5, i32 0, i32 1
    %10 = load i32 (%id_capture*)*, i32 (%id_capture*)** %9
    %11 = load %id_capture*, %id_capture** %8
    %12 = call i32 %10(%id_capture* %11)
    %13 = getelementptr [3 x i8], [3 x i8]* @tmp, i32 0, i32 0
    %14 = call i32 (i8*, ...) @printf(i8* %13, i32 %12)
    ret i32 0
}
</code></pre>
<p>Our <code>id</code> function captures an Integer and return it. To reach that <code>id_capture</code> was introduced for storing captured value. For passing whole closure in convenience, <code>id_closure</code> was introduced and stored capture structure and function pointer. When invoke a closure, get captured structure and function pointer from <code>id_closure</code> structure, then apply function with captured structure and additional arguments(if there's any). In this example omit the part about memory management, all structures allocated in the stack, this won't work in most real world case. Must notice this problem.</p>
<h4 id="improvements">Improvements</h4>
<p>The naive implementation is not good enough, we have several ways can improve it, but instead of implementing them I'm going to list what can we do:</p>
<ul>
<li>Laziness function: Arity would be a thing in case</li>
<li>Access cross asynchronous model</li>
<li>If language has copy capture and reference capture, e.g. C++?</li>
<li>What if working with a GC?</li>
</ul>
<h3 id="return-structure">Return Structure</h3>
<p>When meet program that return structure by value, compiler has chance to remove such cloning. That's storing return structure into a reference passed by the caller. Which means, if we get:</p>
<pre><code class="language-c">struct Foo {
    // ...
};

Foo foo() {
    Foo f;
    // ...
    return f;
}
</code></pre>
<p>should compile to:</p>
<pre><code class="language-llvm">define void @foo(%Foo* noalias sret f) {
    // ...
}
</code></pre>
<ul>
<li><code>sret</code> hints this is a return value.</li>
<li><code>noalias</code> hints other arguments won't point to the same place, LLVM optimizer might rely on such fact, so don't add it everywhere.</li>
</ul>
<h4 id="add-parameter-attributes">Add parameter attributes</h4>
<p>Here is example shows how to add parameter attributes:</p>
<pre><code class="language-go">m := ir.NewModule()

fooTyp := m.NewTypeDef(&quot;Foo&quot;, types.NewStruct(
    types.I32,
))
retS := ir.NewParam(&quot;result&quot;, fooTyp)
retS.Attrs = append(retS.Attrs, enum.ParamAttrNoAlias)
retS.Attrs = append(retS.Attrs, enum.ParamAttrSRet)
m.NewFunc(&quot;foo&quot;, types.Void, retS)
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="control.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Control Flow" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Control Flow
            </div>
          </div>
        </a>
      
      
        
        <a href="types.html" class="md-footer__link md-footer__link--next" aria-label="Next: High Level Types" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              High Level Types
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.477d984a.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.82b56eb2.min.js"></script>
      
    
  </body>
</html>